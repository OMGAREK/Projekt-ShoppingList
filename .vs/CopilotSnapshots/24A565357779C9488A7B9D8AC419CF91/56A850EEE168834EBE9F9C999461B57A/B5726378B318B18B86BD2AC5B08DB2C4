using ShoppingListAW4E.Models;
using ShoppingListAW4E.ViewModels;
using System;

namespace ShoppingListAW4E.Views
{
    public partial class ProductView : ContentView
    {
        public ProductView()
        {
            InitializeComponent();
        }

        void OnDecreaseClicked(object sender, EventArgs e)
        {
            if (BindingContext is Product product && product.Quantity > 0)
            {
                product.Quantity--;
            }
        }

        void OnIncreaseClicked(object sender, EventArgs e)
        {
            if (BindingContext is Product product)
            {
                product.Quantity++;
            }
        }

        void OnBoughtClicked(object sender, EventArgs e)
        {
            if (BindingContext is not Product product)
                return;

            Element parent = this.Parent;
            while (parent != null && parent is not ContentPage)
                parent = parent.Parent;

            if (parent is ContentPage page && page.BindingContext is ShoppingListViewModel vm)
            {
                vm.ToggleBought(product);

                try
                {
                    Element el = this;
                    while (el != null && el is not CollectionView)
                        el = el.Parent;

                    if (el is CollectionView cv)
                    {
                        cv.ScrollTo(product, position: ScrollToPosition.End, animate: true);
                    }
                }
                catch
                {
                }
            }
        }

        void OnRemoveClicked(object sender, EventArgs e)
        {
            Element parent = this.Parent;
            while (parent != null && parent is not ContentPage)
                parent = parent.Parent;

            if (parent is ContentPage page && page.BindingContext is ShoppingListViewModel vm && BindingContext is Product product)
            {
                vm.RemoveProduct(product);
            }
        }
    }
}
