using ShoppingListAW4E.Models;
using System.Collections.ObjectModel;
using System.Text.Json;
using System.Linq;
using System.IO;

namespace ShoppingListAW4E.ViewModels
{
    // VIEWMODEL: ShoppingListViewModel
    // To jest "mózg" aplikacji: przechowuje dane (kategorie i produkty)
    // oraz metody, które modyfikują te dane (dodawanie, usuwanie, zapisywanie).
    public class ShoppingListViewModel
    {
        // Nazwy plików używane do zapisu danych na urządzeniu.
        // To zwykłe pliki tekstowe (JSON), w których przechowujemy listę produktów i kategorii.
        const string ProductFile = "products.json";
        const string CategoryFile = "categories.json";

        // Lista kategorii widoczna w aplikacji.
        // ObservableCollection powiadamia interfejs, gdy elementy zostaną dodane/usunięte.
        public ObservableCollection<Category> Categories { get; set; }
        // Lista wszystkich produktów.
        public ObservableCollection<Product> Products { get; set; }

        // Poniższe pola są powiązane z polami formularza w UI (np. Entry, Picker itd.).
        // Użytkownik wpisuje tutaj dane, a ViewModel odczytuje je podczas dodawania elementów.
        public string NewCategoryName { get; set; }
        public string NewProductName { get; set; }
        public string NewProductUnit { get; set; }
        // Domyślna ilość nowego produktu ustawiona na1.
        public int NewProductQuantity { get; set; } =1;

        // Właściwość przechowująca aktualnie wybraną kategorię w formularzu.
        public Category SelectedCategory { get; set; }

        // KONSTRUKTOR: wykonuje się przy tworzeniu obiektu ViewModel.
        // Główne kroki:
        //1. Wczytanie zapisanych kategorii i produktów z plików (jeśli istnieją).
        //2. Ustawienie, aby kategorie były domyślnie zwinięte.
        //3. Jeśli brak kategorii (pierwsze uruchomienie), tworzymy przykładowe.
        //4. Umieszczenie produktów w ich kategoriach.
        public ShoppingListViewModel()
        {
            Categories = LoadCategories(); // wczytaj zapisane kategorie
            Products = LoadProducts(); // wczytaj zapisane produkty

            // Upewnij się, że żadne kategorie nie są rozwinięte po starcie programu.
            foreach (Category categoryItem in Categories)
            {
                categoryItem.IsExpanded = false; // ustaw każdą kategorię jako zwiniętą
            }

            // Jeśli nie ma żadnych kategorii (np. pierwsze uruchomienie aplikacji),
            // dodajemy kilka przykładowych, aby interfejs nie był pusty.
            if (Categories.Count ==0)
            {
                Categories.Add(new Category("Warzywa") { IsExpanded = false });
                Categories.Add(new Category("Owoce") { IsExpanded = false });
                Categories.Add(new Category("Nabiał") { IsExpanded = false });
                Categories.Add(new Category("Chemia") { IsExpanded = false });
                SaveCategories(); // zapisz domyślne kategorie do pliku
            }

            // Umieść produkty w odpowiadających im kategoriach, aby UI mógł je wyświetlić.
            LoadProductsIntoCategories();
        }

        // METODA: ToggleCategory
        // - Służy do przełączania stanu kategorii (rozwinięta/zwinięta).
        // - Wywoływana, gdy użytkownik kliknie nazwę kategorii.
        public void ToggleCategory(Category category)
        {
            if (category == null)
                return; // nic nie rób, jeśli nie podano kategorii

            category.IsExpanded = !category.IsExpanded; // odwróć stan
        }

        // METODA: AddCategory
        // - Dodaje nową kategorię na podstawie wartości NewCategoryName.
        // Krok po kroku:
        //1. Sprawdza, czy użytkownik wpisał nazwę (nie dodajemy pustych nazw).
        //2. Tworzy nową kategorię i dodaje ją do kolekcji Categories.
        //3. Czyści pole NewCategoryName (ustawia na pusty), aby formularz był gotowy na kolejne dane.
        //4. Zapisuje kategorie do pliku.
        public void AddCategory()
        {
            if (string.IsNullOrWhiteSpace(NewCategoryName))
                return; // jeśli nazwa jest pusta lub tylko białe znaki, nic nie rób

            Categories.Add(new Category(NewCategoryName) { IsExpanded = false });
            NewCategoryName = string.Empty; // wyczyść pole formularza
            SaveCategories(); // zapisz zaktualizowaną listę kategorii
        }

        // METODA: RemoveCategory
        // - Usuwa kategorię oraz wszystkie produkty, które do niej należą.
        // Krok po kroku:
        //1. Usuń wszystkie produkty z globalnej listy Products, które mają tę kategorię.
        //2. Usuń samą kategorię z listy Categories.
        //3. Zapisz zmiany do plików (produkty i kategorie).
        public void RemoveCategory(Category category)
        {
            if (category == null)
                return; // nic nie rób, jeśli brak kategorii

            for (int i = Products.Count -1; i >=0; i--)
            {
                if (Products[i].CategoryName == category.Name)
                    Products.RemoveAt(i); // usuń produkt z listy
            }

            Categories.Remove(category); // usuń kategorię
            SaveProducts(); // zapisz zmienioną listę produktów
            SaveCategories(); // zapisz zmienioną listę kategorii
        }

        // METODA: AddProduct
        // - Dodaje nowy produkt na podstawie pól NewProductName, NewProductUnit itd.
        // Krok po kroku:
        //1. Sprawdza poprawność danych (nazwa i jednostka nie mogą być puste, wybrana kategoria musi istnieć).
        //2. Tworzy obiekt Product i przypisuje mu właściwości z formularza.
        //3. Dodaje produkt do globalnej listy Products.
        //4. Dodaje produkt do listy produktów w odpowiedniej kategorii (Categories[].Products).
        //5. Zapisuje produkty do pliku.
        public void AddProduct()
        {
            if (string.IsNullOrWhiteSpace(NewProductName))
                return; // nie dodawaj pustej nazwy

            if (string.IsNullOrWhiteSpace(NewProductUnit))
                return; // jednostka nie może być pusta

            if (SelectedCategory == null)
                return; // nie dodawaj produktu jeśli nie wybrano kategorii

            Product product = new Product
            {
                Name = NewProductName,
                Unit = NewProductUnit,
                Quantity = NewProductQuantity,
                CategoryName = SelectedCategory.Name
            };

            Products.Add(product); // dodaj do listy wszystkich produktów
            Category targetCategory = Categories.FirstOrDefault(c => c.Name == product.CategoryName);
            targetCategory?.Products.Add(product); // jeśli znaleziono kategorię, dodaj tam produkt

            SaveProducts(); // zapisz zmiany
        }

        // METODA: RemoveProduct
        // - Usuwa pojedynczy produkt zarówno z globalnej listy Products jak i z listy kategorii.
        public void RemoveProduct(Product product)
        {
            if (product == null)
                return; // nic nie rób jeśli produkt jest pusty

            Products.Remove(product); // usuń z ogólnej listy

            foreach (Category categoryInList in Categories)
            {
                if (categoryInList.Products.Contains(product))
                {
                    categoryInList.Products.Remove(product); // usuń z listy kategorii
                    break;
                }
            }

            SaveProducts(); // zapisz zmienioną listę produktów
        }

        // METODA: ToggleBought
        // - Zaznacza produkt jako kupiony lub cofa zaznaczenie.
        // - Dodatkowo organizuje kolejność listy: kupione produkty przenosimy na koniec.
        // - Robimy to zarówno w globalnej liście Products jak i w liście produktów w kategorii.
        public void ToggleBought(Product product)
        {
            if (product == null)
                return; // jeśli brak produktu, nic nie rób

            product.IsBought = !product.IsBought; // odwróć flagę kupione/niekupione

            // Najpierw usuń produkt z globalnej listy, aby móc go wstawić w nowe miejsce
            Products.Remove(product);

            // Jeśli produkt jest kupiony, dodaj go na koniec listy
            if (product.IsBought)
            {
                Products.Add(product);
            }
            // Jeśli produkt nie jest kupiony, znajdź pozycję pierwszego kupionego produktu
            // i wstaw przed nim, aby niekupione produkty były na początku listy
            else
            {
                int index =0; // zaczynamy od początku listy
                while (index < Products.Count && !Products[index].IsBought)
                    index++; // przesuwamy się aż do pierwszego kupionego
                Products.Insert(index, product); // wstaw produkt na znalezione miejsce
            }

            // Zaktualizuj również listę produktów wewnątrz odpowiedniej kategorii
            Category category = Categories.FirstOrDefault(c => c.Name == product.CategoryName);
            if (category != null)
            {
                // Usuń produkt z listy kategorii - podobnie jak w liście globalnej
                category.Products.Remove(product);

                // Jeśli kupiony, dodaj na koniec listy kategorii
                if (product.IsBought)
                    category.Products.Add(product);
                else
                {
                    // Jeśli nie kupiony, znajdź miejsce przed pierwszym kupionym w kategorii
                    int categoryIndex =0;
                    while (categoryIndex < category.Products.Count && !category.Products[categoryIndex].IsBought)
                        categoryIndex++;
                    category.Products.Insert(categoryIndex, product);
                }
            }

            SaveProducts(); // zapisz zmiany
        }

        // METODA: LoadProductsIntoCategories
        // - Przypisuje każdy produkt do jego kategorii na podstawie pola CategoryName.
        void LoadProductsIntoCategories()
        {
            // Dla każdego produktu w globalnej liście znajdź jego kategorię i dodaj go do niej
            foreach (Product product in Products)
            {
                Category category = Categories.FirstOrDefault(c => c.Name == product.CategoryName);
                // jeśli znaleziono kategorię, dodaj produkt do jej listy (operator ?. oznacza "jeśli nie null")
                category?.Products.Add(product);
            }
        }

        // METODA: LoadProducts
        // - Wczytuje produkty z pliku JSON. Jeśli plik nie istnieje, zwraca pustą listę.
        ObservableCollection<Product> LoadProducts()
        {
            // Zbuduj pełną ścieżkę do pliku z produktami
            string path = Path.Combine(FileSystem.AppDataDirectory, ProductFile);
            // Jeśli plik nie istnieje, zwróć pustą kolekcję zamiast null
            if (!File.Exists(path))
                return new ObservableCollection<Product>();

            // Wczytaj zawartość pliku i spróbuj zdeserializować do kolekcji produktów
            return JsonSerializer.Deserialize<ObservableCollection<Product>>(File.ReadAllText(path))
                // jeśli deserializacja zwróci null, to zwróć pustą kolekcję
                ?? new ObservableCollection<Product>();
        }

        // METODA: LoadCategories
        // - Podobnie jak wyżej, ale dla kategorii.
        ObservableCollection<Category> LoadCategories()
        {
            // Zbuduj pełną ścieżkę do pliku z kategoriami
            string path = Path.Combine(FileSystem.AppDataDirectory, CategoryFile);
            // Jeśli plik nie istnieje, zwróć pustą kolekcję
            if (!File.Exists(path))
                return new ObservableCollection<Category>();

            // Wczytaj i zdeserializuj listę kategorii; w razie problemów zwróć pustą kolekcję
            return JsonSerializer.Deserialize<ObservableCollection<Category>>(File.ReadAllText(path))
                 ?? new ObservableCollection<Category>();
        }

        // METODA: SaveProducts
        // - Zapisuje listę produktów do pliku w formacie JSON. JSON to format tekstowy,
        // który przechowuje dane w czytelnej formie.
        public void SaveProducts()
        {
            // Zbuduj ścieżkę do pliku i zapisz zserializowane produkty
            string path = Path.Combine(FileSystem.AppDataDirectory, ProductFile);
            File.WriteAllText(path, JsonSerializer.Serialize(Products, new JsonSerializerOptions { WriteIndented = true }));
        }

        // METODA: SaveCategories
        // - Zapisuje listę kategorii do pliku JSON.
        void SaveCategories()
        {
            // Zbuduj ścieżkę do pliku i zapisz zserializowane kategorie
            string path = Path.Combine(FileSystem.AppDataDirectory, CategoryFile);
            File.WriteAllText(path, JsonSerializer.Serialize(Categories, new JsonSerializerOptions { WriteIndented = true }));
        }
    }
}
