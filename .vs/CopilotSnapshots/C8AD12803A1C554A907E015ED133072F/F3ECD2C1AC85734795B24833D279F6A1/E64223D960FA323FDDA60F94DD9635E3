using ShoppingListAW4E.Models;
using System.Collections.ObjectModel;
using System.Text.Json;
using System.IO;
using System.Linq;

namespace ShoppingListAW4E.Views
{
    public partial class ShoppingListPage : ContentPage
    {
        const string ProductFile = "products.json";
        const string CategoryFile = "categories.json";

        public ObservableCollection<Category> Categories { get; set; }
        public ObservableCollection<Product> Products { get; set; }

        public ShoppingListPage()
        {
            InitializeComponent();
            Categories = LoadCategories();
            Products = LoadProducts();

            foreach (var c in Categories)
                c.IsExpanded = false;

            if (Categories.Count == 0)
            {
                Categories.Add(new Category("Warzywa") { IsExpanded = false });
                Categories.Add(new Category("Owoce") { IsExpanded = false });
                Categories.Add(new Category("Nabiał") { IsExpanded = false });
                Categories.Add(new Category("Chemia") { IsExpanded = false });
                SaveCategories();
            }

            LoadProductsIntoCategories();

            CategoryCollectionView.ItemsSource = Categories;
            CategoryPicker.ItemsSource = Categories;
        }

        void OnCategoryClicked(object sender, EventArgs e)
        {
            var button = sender as Button;
            var category = button?.BindingContext as Category;
            if (category != null)
                category.IsExpanded = !category.IsExpanded;
        }

        void OnAddCategoryClicked(object sender, EventArgs e)
        {
            string newName = NewCategoryEntry.Text;
            if (string.IsNullOrWhiteSpace(newName))
                return;
            Categories.Add(new Category(newName) { IsExpanded = false });
            NewCategoryEntry.Text = string.Empty;
            SaveCategories();
        }

        void OnAddProductClicked(object sender, EventArgs e)
        {
            string name = NewProductNameEntry.Text;
            string unit = NewProductUnitEntry.Text;
            if (!int.TryParse(NewProductQuantityEntry.Text, out int qty))
                qty = 1;
            var selected = CategoryPicker.SelectedItem as Category;
            if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(unit) || selected == null)
                return;

            var product = new Product { Name = name, Unit = unit, Quantity = qty, CategoryName = selected.Name };
            Products.Add(product);
            selected.Products.Add(product);

            NewProductNameEntry.Text = string.Empty;
            NewProductQuantityEntry.Text = string.Empty;
            NewProductUnitEntry.Text = string.Empty;
            SaveProducts();
        }

        void OnRemoveCategoryClicked(object sender, EventArgs e)
        {
            var button = sender as Button;
            var category = button?.BindingContext as Category;
            if (category == null)
                return;
            for (int i = Products.Count - 1; i >= 0; i--)
            {
                if (Products[i].CategoryName == category.Name)
                    Products.RemoveAt(i);
            }
            Categories.Remove(category);
            SaveProducts();
            SaveCategories();
        }

        public void RemoveProduct(Product product)
        {
            if (product == null) return;
            Products.Remove(product);
            foreach (var c in Categories)
            {
                if (c.Products.Contains(product)) { c.Products.Remove(product); break; }
            }
            SaveProducts();
        }

        public void ToggleBought(Product product)
        {
            if (product == null) return;
            product.IsBought = !product.IsBought;
            Products.Remove(product);
            if (product.IsBought) Products.Add(product);
            else
            {
                int index = 0;
                while (index < Products.Count && !Products[index].IsBought) index++;
                Products.Insert(index, product);
            }
            var category = Categories.FirstOrDefault(c => c.Name == product.CategoryName);
            if (category != null)
            {
                category.Products.Remove(product);
                if (product.IsBought) category.Products.Add(product);
                else
                {
                    int ci = 0;
                    while (ci < category.Products.Count && !category.Products[ci].IsBought) ci++;
                    category.Products.Insert(ci, product);
                }
            }
            SaveProducts();
        }

        void LoadProductsIntoCategories()
        {
            foreach (var p in Products)
            {
                var c = Categories.FirstOrDefault(x => x.Name == p.CategoryName);
                c?.Products.Add(p);
            }
        }

        ObservableCollection<Product> LoadProducts()
        {
            string path = Path.Combine(FileSystem.AppDataDirectory, ProductFile);
            if (!File.Exists(path)) return new ObservableCollection<Product>();
            return JsonSerializer.Deserialize<ObservableCollection<Product>>(File.ReadAllText(path)) ?? new ObservableCollection<Product>();
        }

        ObservableCollection<Category> LoadCategories()
        {
            string path = Path.Combine(FileSystem.AppDataDirectory, CategoryFile);
            if (!File.Exists(path)) return new ObservableCollection<Category>();
            return JsonSerializer.Deserialize<ObservableCollection<Category>>(File.ReadAllText(path)) ?? new ObservableCollection<Category>();
        }

        public void SaveProducts()
        {
            string path = Path.Combine(FileSystem.AppDataDirectory, ProductFile);
            File.WriteAllText(path, JsonSerializer.Serialize(Products, new JsonSerializerOptions { WriteIndented = true }));
        }

        void SaveCategories()
        {
            string path = Path.Combine(FileSystem.AppDataDirectory, CategoryFile);
            File.WriteAllText(path, JsonSerializer.Serialize(Categories, new JsonSerializerOptions { WriteIndented = true }));
        }
    }
}